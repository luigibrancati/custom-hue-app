# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Custom Hue is a Flutter app for controlling Philips Hue lights over Bluetooth Low Energy (BLE). It bypasses the Hue Bridge entirely, communicating directly with lights using the `flutter_reactive_ble` package.

## Common Commands

- **Run app:** `flutter run` (targets Android/iOS/Linux/macOS/Windows/Web)
- **Analyze:** `flutter analyze`
- **Run tests:** `flutter test`
- **Run single test:** `flutter test test/widget_test.dart`
- **Code generation (Hive adapters):** `dart run build_runner build --delete-conflicting-outputs`
- **Get dependencies:** `flutter pub get`

## Architecture

### State Management
Provider pattern with `ChangeNotifierProvider`. All providers are wired up in `main.dart` via `MultiProvider`. Each provider wraps a service layer and exposes reactive state to the UI.

### BLE Communication (lib/services/ble/)
- **TLV Protocol:** Light commands use a custom Type-Length-Value binary encoding (`TlvEncoder`). Tags: `0x01`=on/off, `0x02`=brightness (1-254), `0x03`=color temp (mireds, 2 bytes LE), `0x04`=CIE xy color (4 bytes LE). All writes go to a single combined control characteristic.
- **BLE UUIDs** are defined in `lib/core/constants/ble_uuids.dart`. The primary service UUID is `932c32bd-0000-...`.
- **Throttling:** BLE writes from continuous controls (sliders, color picker) are throttled per-device to avoid overwhelming the radio.

### Color System (lib/core/utils/color_utils.dart)
Colors are represented internally as CIE 1931 xy coordinates (the format Hue lights use). Conversions exist between sRGB, CIE xy, mireds (color temperature), and display colors. The CIE xy values are scaled to 16-bit integers (0–65535) for BLE transmission.

### Persistence (lib/services/persistence/)
Uses Hive for local storage with generated type adapters. Models with `@HiveType` annotations have corresponding `.g.dart` files generated by `build_runner`. Boxes: lights, rooms, scenes, schedules, favorites.

### Scheduling (lib/services/scheduling/)
Uses `android_alarm_manager_plus` for scheduled light actions. `FadeService` handles gradual brightness transitions with configurable duration.

### Layer Structure
```
screens/ → UI screens with per-screen widgets/ subdirectories
providers/ → ChangeNotifier state management (one per domain)
services/ → Business logic (ble/, persistence/, scheduling/)
models/ → Data classes with Hive annotations
core/ → Constants, theme, utilities
```

### Key Conventions
- Models that need Hive persistence use `@HiveType`/`@HiveField` annotations and require running `build_runner` after changes.
- Optimistic UI updates: providers update local state immediately, then send BLE commands asynchronously.
- SDK constraint: `^3.11.0` (Dart 3.11+), uses modern Dart features like records `(double x, double y)`.
