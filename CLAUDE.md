# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Custom Hue is a Flutter app for controlling Philips Hue lights over Bluetooth Low Energy (BLE). It bypasses the Hue Bridge entirely, communicating directly with lights using the `flutter_reactive_ble` package.

## Common Commands

- **Run app:** `flutter run` (targets Android/iOS/Linux/macOS/Windows/Web)
- **Analyze:** `flutter analyze`
- **Run tests:** `flutter test`
- **Run single test:** `flutter test test/widget_test.dart`
- **Code generation (Hive adapters):** `dart run build_runner build --delete-conflicting-outputs`
- **Get dependencies:** `flutter pub get`

## Architecture

### State Management
Provider pattern with `ChangeNotifierProvider`. All providers are wired up in `main.dart` via `MultiProvider`. Each provider wraps a service layer and exposes reactive state to the UI.

Initialization order in `main.dart` matters:
1. `HiveService.init()` — opens all Hive boxes
2. `AlarmSchedulerService.init()` — initializes Android Alarm Manager
3. BLE services instantiated, then providers created around them
4. `BleConnectionProvider` accepts an `onDeviceConnected` callback that immediately calls `readState()` on reconnect — this is how the UI syncs with actual light state

### BLE Communication (lib/services/ble/)
- **TLV Protocol:** Light commands use a custom Type-Length-Value binary encoding (`TlvEncoder`). Tags: `0x01`=on/off, `0x02`=brightness (1-254), `0x03`=color temp (mireds, 2 bytes LE), `0x04`=CIE xy color (4 bytes LE). All writes go to a single combined control characteristic (`932c32bd-0007-...`) using `writeCharacteristicWithResponse`.
- **BLE UUIDs** are defined in `lib/core/constants/ble_uuids.dart`. The primary service UUID is `932c32bd-0000-...`. Scan filters on `deviceConfigService` UUID.
- **Throttling:** BLE writes from continuous controls (sliders, color picker) are throttled per-device at 80ms to avoid overwhelming the radio. The throttle cancels any pending timer when called again, so only the final value in a burst is guaranteed to be sent.

### Color System (lib/core/utils/color_utils.dart)
Colors exist in three representations:
- **Internal:** CIE 1931 xy floats (0–1), what Hue lights use natively
- **BLE wire:** CIE xy scaled to 16-bit integers (0–65535)
- **UI display:** Flutter `Color` (sRGB), converted via D65 white point and Hue gamut coefficients

Conversions exist between sRGB, CIE xy, mireds (color temperature), and display colors. Mireds→RGB uses a Planck's law approximation.

### Persistence (lib/services/persistence/)
Uses Hive for local storage with generated type adapters. Models with `@HiveType` annotations have corresponding `.g.dart` files generated by `build_runner`. Boxes: lights, rooms, scenes, schedules, favorites.

**Hive typeIds are fixed** — changing them breaks existing stored data:
- `HueLight` → 0, `Room` → 1, `Scene` → 2, `Schedule` → 3, `FavoriteColor` → 4

`LightState` is a runtime-only model (no Hive annotation); it holds the current state read from a device and has a `copyWith()` method.

Deleting a light cascades: it is removed from all rooms and schedules in the storage layer.

### Scheduling (lib/services/scheduling/)
Uses `android_alarm_manager_plus` for scheduled light actions. Each schedule creates a **separate alarm per day-of-week** (allows per-day enable/disable). Alarms use `rescheduleOnReboot: true`.

`alarm_callback_dispatcher.dart` is the isolate entry point (`@pragma('vm:entry-point')`). It runs completely independently of the main isolate and must re-initialize Hive and register all adapters before reading any data. BLE execution here is best-effort.

`FadeService` runs `Timer.periodic` at 100ms intervals and calculates brightness deltas over the configured duration.

### Navigation
No named routes or routing library. All navigation is imperative via `Navigator.push()` with `MaterialPageRoute`. Each screen folder under `screens/` has a `widgets/` subdirectory for screen-specific components.

### Layer Structure
```
screens/ → UI screens with per-screen widgets/ subdirectories
providers/ → ChangeNotifier state management (one per domain)
services/ → Business logic (ble/, persistence/, scheduling/)
models/ → Data classes with Hive annotations
core/ → Constants, theme, utilities
```

### Key Conventions
- Models that need Hive persistence use `@HiveType`/`@HiveField` annotations and require running `build_runner` after changes.
- Optimistic UI updates: providers update local state immediately, then send BLE commands asynchronously. Errors do not roll back UI state.
- `Schedule.daysOfWeek` uses Dart's `weekday` convention: 1=Monday, 7=Sunday.
- All magic numbers (timeouts, brightness range, color temp range, preset scene values) live in `lib/core/constants/app_constants.dart`.
- SDK constraint: `^3.11.0` (Dart 3.11+), uses modern Dart features like records `(double x, double y)`.
